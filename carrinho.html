<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja Virtual - Carrinho</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <ul class="menu">
            <li><a href="index.html">Produtos</a></li>
            <li><a href="carrinho.html" class="active">Carrinho</a></li>
            <li><a href="checkout.html">Finalizar Compra</a></li>
            <li><a href="login.html" id="login-link">Login</a></li>
            <li><a href="#" id="logout-link" style="display:none;">Sair</a></li>
        </ul>
    </nav>

    <main>
        <h1>Seu Carrinho</h1>
        
        <form action="checkout.html" method="get">
            <div class="carrinho-lista">
                <!-- Produto 1 -->
                <div class="carrinho-item" style="display:none" id="item1">
                    <div class="produto-info">
                        <h3>Capinha para IPhone</h3>
                        <p>Quantidade: <span id="qtd1">0</span></p>
                        <p>Pre√ßo: R$ 99,90</p>
                    </div>
                    <input type="hidden" name="prod1" value="sim">
                    <input type="hidden" name="qtd1" value="0">
                    <input type="hidden" name="nome1" value="Capinha para IPhone">
                    <input type="hidden" name="preco1" value="99.90">
                </div>

                <!-- Produto 2 -->
                <div class="carrinho-item" style="display:none" id="item2">
                    <div class="produto-info">
                        <h3>Carregador MagSafe</h3>
                        <p>Quantidade: <span id="qtd2">0</span></p>
                        <p>Pre√ßo: R$ 500,90</p>
                    </div>
                    <input type="hidden" name="prod2" value="sim">
                    <input type="hidden" name="qtd2" value="0">
                    <input type="hidden" name="nome2" value="Carregador MagSafe">
                    <input type="hidden" name="preco2" value="500.90">
                </div>

                <!-- Produto 3 -->
                <div class="carrinho-item" style="display:none" id="item3">
                    <div class="produto-info">
                        <h3>IPhone 15</h3>
                        <p>Quantidade: <span id="qtd3">0</span></p>
                        <p>Pre√ßo: R$ 5.000,90</p>
                    </div>
                    <input type="hidden" name="prod3" value="sim">
                    <input type="hidden" name="qtd3" value="0">
                    <input type="hidden" name="nome3" value="IPhone 15">
                    <input type="hidden" name="preco3" value="5000.90">
                </div>

                <!-- Produto 4 -->
                <div class="carrinho-item" style="display:none" id="item4">
                    <div class="produto-info">
                        <h3>Apple Watch</h3>
                        <p>Quantidade: <span id="qtd4">0</span></p>
                        <p>Pre√ßo: R$ 2.500,90</p>
                    </div>
                    <input type="hidden" name="prod4" value="sim">
                    <input type="hidden" name="qtd4" value="0">
                    <input type="hidden" name="nome4" value="Apple Watch">
                    <input type="hidden" name="preco4" value="2500.90">
                </div>

                <!-- Produto 5 -->
                <div class="carrinho-item" style="display:none" id="item5">
                    <div class="produto-info">
                        <h3>AirPods</h3>
                        <p>Quantidade: <span id="qtd5">0</span></p>
                        <p>Pre√ßo: R$ 999,90</p>
                    </div>
                    <input type="hidden" name="prod5" value="sim">
                    <input type="hidden" name="qtd5" value="0">
                    <input type="hidden" name="nome5" value="AirPods">
                    <input type="hidden" name="preco5" value="999.90">
                </div>

                <!-- Mensagem de carrinho vazio -->
                <div class="carrinho-vazio">
                    <p>Seu carrinho est√° vazio. <a href="index.html">Continuar comprando</a></p>
                </div>
            </div>

            <div class="carrinho-total">
                <h3>Total da Compra: R$ <span id="total">0,00</span></h3>
                <input type="hidden" name="total" value="0.00">
                <div class="botoes">
                    <a href="index.html" class="btn-voltar">&larr; Continuar Comprando</a>
                    <button type="submit" class="btn-finalizar">Finalizar Compra</button>
                </div>
            </div>
        </form>
    </main>

    <!-- Script melhorado para mostrar os produtos selecionados -->
    <script>
        const API_BASE = 'http://localhost:3001';
        
        // Verifica autentica√ß√£o ao carregar
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (token && user) {
                // Mostra link de logout e esconde login
                document.getElementById('login-link').style.display = 'none';
                document.getElementById('logout-link').style.display = 'block';
            } else {
                // Redireciona para login se n√£o estiver autenticado
                window.location.href = 'login.html';
            }
        }
        
        // Fun√ß√£o de logout
        function handleLogout(event) {
            event.preventDefault();
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
        
        // Event listener para logout
        document.getElementById('logout-link').addEventListener('click', handleLogout);
        
        // Verifica autentica√ß√£o ao carregar
        checkAuth();
        
        let total = 0;
        let temProdutos = false;

        // Fun√ß√£o para formatar pre√ßo em Real
        function formatarPreco(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Fun√ß√£o para carregar carrinho do localStorage
        function carregarCarrinho() {
            const carrinho = JSON.parse(localStorage.getItem('carrinho') || '{}');
            console.log('üõí Carrinho carregado do localStorage:', carrinho);
            
            // Verifica cada produto
            for (let i = 1; i <= 5; i++) {
                const produto = carrinho[`prod${i}`];
                const item = document.getElementById('item' + i);
                
                if (produto && produto.selecionado && produto.quantidade > 0) {
                    const subtotal = produto.preco * produto.quantidade;
                    
                    item.style.display = 'block';
                    document.getElementById('qtd' + i).textContent = produto.quantidade;
                    
                    // Atualiza os campos hidden
                    item.querySelector('input[name="prod' + i + '"]').value = 'sim';
                    item.querySelector('input[name="qtd' + i + '"]').value = produto.quantidade;
                    item.querySelector('input[name="nome' + i + '"]').value = produto.nome;
                    item.querySelector('input[name="preco' + i + '"]').value = produto.preco;
                    
                    // Remove subtotal anterior se existir
                    const subtotalAnterior = item.querySelector('.subtotal');
                    if (subtotalAnterior) {
                        subtotalAnterior.remove();
                    }
                    
                    // Adiciona o subtotal ao item
                    const subtotalElement = document.createElement('p');
                    subtotalElement.className = 'subtotal';
                    subtotalElement.textContent = `Subtotal: ${formatarPreco(subtotal)}`;
                    item.querySelector('.produto-info').appendChild(subtotalElement);
                    
                    total += subtotal;
                    temProdutos = true;
                    
                    console.log(`‚úÖ Produto ${i} adicionado: ${produto.nome} x${produto.quantidade}`);
                } else {
                    // Garante que o item est√° escondido se n√£o foi selecionado
                    item.style.display = 'none';
                }
            }
            
            if (!temProdutos) {
                console.warn('‚ö†Ô∏è Nenhum produto encontrado no carrinho');
            }
        }

        // Fun√ß√£o para atualizar a interface
        function atualizarInterface() {
            // Atualiza o total com formata√ß√£o em Real
            document.getElementById('total').textContent = formatarPreco(total).replace('R$', '').trim();
            document.querySelector('input[name="total"]').value = total.toFixed(2);

            // Mostra/esconde mensagem de carrinho vazio
            const carrinhoVazio = document.querySelector('.carrinho-vazio');
            const btnFinalizar = document.querySelector('.btn-finalizar');
            
            if (temProdutos) {
                carrinhoVazio.style.display = 'none';
                btnFinalizar.disabled = false;
            } else {
                carrinhoVazio.style.display = 'block';
                btnFinalizar.disabled = true;
            }
        }

        // Carrega o carrinho e atualiza a interface
        carregarCarrinho();
        atualizarInterface();
    </script>
</body>
</html> 