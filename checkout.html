<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja Virtual - Finalizar Compra</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <ul class="menu">
            <li><a href="index.html">Produtos</a></li>
            <li><a href="carrinho.html">Carrinho</a></li>
            <li><a href="checkout.html" class="active">Finalizar Compra</a></li>
            <li><a href="login.html" id="login-link">Login</a></li>
            <li><a href="#" id="logout-link" style="display:none;">Sair</a></li>
        </ul>
    </nav>

    <main>
        <h1>Finalizar Compra</h1>
        
        <!-- Resumo da compra -->
        <div class="resumo-compra">
            <h2>Resumo do Pedido</h2>
            <div id="itens-resumo"></div>
            <div class="checkout-total">
                <h3>Valor Total da Compra: R$ <span id="total">0,00</span></h3>
            </div>
        </div>

        <!-- Abas de navega√ß√£o -->
        <div class="abas-navegacao">
            <button type="button" class="aba-btn ativa" onclick="mostrarAba('dados-pessoais')">Dados Pessoais</button>
            <button type="button" class="aba-btn" onclick="mostrarAba('dados-cartao')">Pagamento</button>
        </div>

        <form id="checkout-form" action="/finalizar" method="post">
            <!-- Aba Dados Pessoais -->
            <div id="dados-pessoais" class="aba-conteudo ativa">
                <h2>Dados Pessoais e Endere√ßo</h2>
                <div class="form-group">
                    <label for="nome">Nome Completo:</label>
                    <input type="text" id="nome" name="nome" required 
                           pattern="[A-Za-z√Ä-√ø\s]{3,}" 
                           title="Digite seu nome completo (m√≠nimo 3 caracteres)">
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="telefone">Telefone:</label>
                    <input type="tel" id="telefone" name="telefone" required
                           pattern="[\d\s()-]{10,}"
                           title="Digite um telefone v√°lido">
                </div>
                <div class="form-group">
                    <label for="cep">CEP:</label>
                    <input type="text" id="cep" name="cep" required
                           pattern="[\d]{5}-?[\d]{3}"
                           title="Digite um CEP v√°lido (00000-000)">
                </div>
                <div class="form-group">
                    <label for="endereco">Endere√ßo Completo:</label>
                    <textarea id="endereco" name="endereco" required
                              minlength="10"
                              title="Digite seu endere√ßo completo"></textarea>
                </div>
                <div class="botoes">
                    <a href="carrinho.html" class="btn-voltar">&larr; Voltar ao Carrinho</a>
                    <button type="button" class="btn-proximo" onclick="proximaAba()">Ir para Pagamento</button>
                </div>
            </div>

            <!-- Aba Dados do Cart√£o -->
            <div id="dados-cartao" class="aba-conteudo">
                <h2>Pagamento com Cart√£o de Cr√©dito</h2>
                <div class="form-group">
                    <label for="nome-cartao">Nome no Cart√£o:</label>
                    <input type="text" id="nome-cartao" name="nome-cartao" required
                           pattern="[A-Za-z√Ä-√ø\s]{3,}"
                           title="Digite o nome como aparece no cart√£o">
                </div>
                <div class="form-group">
                    <label for="numero-cartao">N√∫mero do Cart√£o:</label>
                    <input type="text" id="numero-cartao" name="numero-cartao" required
                           pattern="[\d]{4}[\s]?[\d]{4}[\s]?[\d]{4}[\s]?[\d]{4}"
                           title="Digite o n√∫mero do cart√£o (16 d√≠gitos)"
                           maxlength="19">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="validade">Validade (MM/AA):</label>
                        <input type="text" id="validade" name="validade" required
                               pattern="[\d]{2}/[\d]{2}"
                               title="Digite a validade no formato MM/AA"
                               maxlength="5">
                    </div>
                    <div class="form-group">
                        <label for="cvv">CVV:</label>
                        <input type="text" id="cvv" name="cvv" required
                               pattern="[\d]{3,4}"
                               title="Digite o CVV (3 ou 4 d√≠gitos)"
                               maxlength="4">
                    </div>
                </div>
                <div class="form-group">
                    <label for="parcelas">Parcelas:</label>
                    <select id="parcelas" name="parcelas" required>
                        <option value="">Selecione o n√∫mero de parcelas</option>
                        <option value="1">1x sem juros</option>
                        <option value="2">2x sem juros</option>
                        <option value="3">3x sem juros</option>
                        <option value="4">4x sem juros</option>
                        <option value="5">5x sem juros</option>
                        <option value="6">6x sem juros</option>
                        <option value="7">7x sem juros</option>
                        <option value="8">8x sem juros</option>
                        <option value="9">9x sem juros</option>
                        <option value="10">10x sem juros</option>
                        <option value="11">11x sem juros</option>
                        <option value="12">12x sem juros</option>
                    </select>
                </div>
                <div class="botoes">
                    <button type="button" class="btn-voltar" onclick="abaAnterior()">&larr; Voltar</button>
                    <button type="button" class="btn-finalizar-compra" onclick="finalizarCompra()">Finalizar Compra</button>
                </div>
            </div>

            <input type="hidden" name="total" id="total-hidden" value="0.00">
        </form>
    </main>

    <script>
        const API_BASE = 'http://localhost:3001';
        
        // Verifica autentica√ß√£o ao carregar
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (token && user) {
                // Mostra link de logout e esconde login
                document.getElementById('login-link').style.display = 'none';
                document.getElementById('logout-link').style.display = 'block';
            } else {
                // Redireciona para login se n√£o estiver autenticado
                window.location.href = 'login.html';
            }
        }
        
        // Fun√ß√£o de logout
        function handleLogout(event) {
            event.preventDefault();
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
        
        // Event listener para logout
        document.getElementById('logout-link').addEventListener('click', handleLogout);
        
        // Verifica autentica√ß√£o ao carregar
        checkAuth();
        
        // Fun√ß√£o para formatar pre√ßo em Real
        function formatarPreco(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        let total = 0;

        // Fun√ß√£o para carregar carrinho do localStorage
        function carregarCarrinho() {
            const carrinho = JSON.parse(localStorage.getItem('carrinho') || '{}');
            const resumoDiv = document.getElementById('itens-resumo');
            
            // Limpa o resumo anterior
            resumoDiv.innerHTML = '';
            
            // Verifica cada produto
            for (let i = 1; i <= 5; i++) {
                const produto = carrinho[`prod${i}`];
                if (produto && produto.selecionado && produto.quantidade > 0) {
                    const subtotal = produto.preco * produto.quantidade;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-resumo';
                    itemDiv.innerHTML = `
                        <p><strong>${produto.nome}</strong></p>
                        <p>Quantidade: ${produto.quantidade}</p>
                        <p>Pre√ßo unit√°rio: ${formatarPreco(produto.preco)}</p>
                        <p>Subtotal: ${formatarPreco(subtotal)}</p>
                    `;
                    resumoDiv.appendChild(itemDiv);
                    
                    total += subtotal;
                }
            }
        }

        // Fun√ß√£o para atualizar a interface
        function atualizarInterface() {
            // Atualiza o total
            document.getElementById('total').textContent = formatarPreco(total).replace('R$', '').trim();
            document.getElementById('total-hidden').value = total.toFixed(2);
        }

        // Carrega o carrinho e atualiza a interface
        carregarCarrinho();
        atualizarInterface();

        // Formata o CEP automaticamente
        document.getElementById('cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5, 8);
            }
            e.target.value = value;
        });

        // Formata o telefone automaticamente
        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                value = '(' + value;
                if (value.length > 3) {
                    value = value.slice(0, 3) + ') ' + value.slice(3);
                }
                if (value.length > 10) {
                    value = value.slice(0, 10) + '-' + value.slice(10, 14);
                }
            }
            e.target.value = value;
        });

        // Formata o n√∫mero do cart√£o automaticamente
        document.getElementById('numero-cartao').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                value = value.match(/.{1,4}/g).join(' ');
                if (value.length > 19) value = value.slice(0, 19);
            }
            e.target.value = value;
        });

        // Formata a validade automaticamente
        document.getElementById('validade').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Formata o CVV (apenas n√∫meros)
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Fun√ß√µes para navega√ß√£o entre abas
        function mostrarAba(abaId) {
            // Remove classe ativa de todas as abas
            document.querySelectorAll('.aba-btn').forEach(btn => btn.classList.remove('ativa'));
            document.querySelectorAll('.aba-conteudo').forEach(conteudo => conteudo.classList.remove('ativa'));
            
            // Adiciona classe ativa na aba selecionada
            event.target.classList.add('ativa');
            document.getElementById(abaId).classList.add('ativa');
        }

        function proximaAba() {
            // Valida os campos da primeira aba
            const camposObrigatorios = ['nome', 'email', 'telefone', 'cep', 'endereco'];
            let valido = true;
            
            camposObrigatorios.forEach(campo => {
                const input = document.getElementById(campo);
                if (!input.value.trim() || !input.checkValidity()) {
                    input.style.borderColor = '#e74c3c';
                    valido = false;
                } else {
                    input.style.borderColor = '#ddd';
                }
            });

            if (!valido) {
                alert('Por favor, preencha todos os campos obrigat√≥rios corretamente.');
                return;
            }

            // Mostra a segunda aba
            mostrarAba('dados-cartao');
            document.querySelectorAll('.aba-btn')[1].classList.add('ativa');
        }

        function abaAnterior() {
            mostrarAba('dados-pessoais');
            document.querySelectorAll('.aba-btn')[0].classList.add('ativa');
        }

        function finalizarCompra() {
            // Valida os campos do cart√£o
            const camposCartao = ['nome-cartao', 'numero-cartao', 'validade', 'cvv', 'parcelas'];
            let valido = true;
            
            camposCartao.forEach(campo => {
                const input = document.getElementById(campo);
                if (!input.value.trim() || !input.checkValidity()) {
                    input.style.borderColor = '#e74c3c';
                    valido = false;
                } else {
                    input.style.borderColor = '#ddd';
                }
            });

            if (!valido) {
                alert('Por favor, preencha todos os dados do cart√£o corretamente.');
                return;
            }

            // Verifica se h√° itens no carrinho
            if (total <= 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }

            // Mostra mensagem de sucesso
            const parcelas = document.getElementById('parcelas').value;
            const valorParcela = (total / parseInt(parcelas)).toFixed(2);
            
            alert(`üéâ Compra realizada com sucesso!\n\n` +
                  `Valor total: R$ ${total.toFixed(2)}\n` +
                  `Parcelas: ${parcelas}x de R$ ${valorParcela}\n\n` +
                  `Voc√™ receber√° um email de confirma√ß√£o em breve!`);
            
            // Limpa o carrinho ap√≥s a compra
            localStorage.removeItem('carrinho');
            
            // Redireciona para a p√°gina inicial
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }
    </script>
</body>
</html> 
</html> 