<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja Virtual - Produtos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <ul class="menu">
            <li><a href="index.html" class="active">Produtos</a></li>
            <li><a href="carrinho.html">Carrinho</a></li>
            <li><a href="checkout.html">Finalizar Compra</a></li>
        </ul>
    </nav>

    <main>
        <h1>Nossos Produtos</h1>
        
        <!-- Um único formulário para todos os produtos -->
        <form action="carrinho.html" method="get" id="produtos-form">
            <div class="produtos-grid">
                <!-- Produto 1 -->
                <div class="produto-card">
                    <img src="img/iphone rosa.png" alt="Produto 1">
                    <h3>Capinha para IPhone </h3>
                    <p>Mantenha seu iPhone seguro sem abrir mão do estilo! Nossa capinha combina design moderno, acabamento premium e proteção completa contra quedas e arranhões. Leve e resistente, ela se encaixa perfeitamente no seu aparelho, garantindo acesso fácil a todas as portas, botões e câmeras. Disponível em diversas cores e padrões, é o acessório ideal para proteger e personalizar seu iPhone no dia a dia.</p>
                    <p class="preco">R$ 99,90</p>
                    <p class="estoque">Estoque: <span class="estoque-valor" data-sku="CASE-IPHN">--</span></p>
                    <div class="produto-selecao">
                        <label>
                            <input type="checkbox" name="prod1" value="sim">
                            Adicionar ao Carrinho
                        </label>
                        <select name="qtd1">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>

                <!-- Produto 2 -->
                <div class="produto-card">
                    <img src="img/magsafe.png" alt="Produto 2">
                    <h3>Carregador MagSafe</h3>
                    <p>Experimente a praticidade do carregamento sem fio com o MagSafe! Projetado especialmente para iPhone, ele alinha-se magneticamente ao aparelho, garantindo conexão perfeita e eficiente a cada uso. Com tecnologia de carregamento rápido, mantém seu iPhone pronto para o dia a dia, enquanto seu design compacto e elegante combina com qualquer ambiente. Simples, seguro e inteligente, é o acessório que facilita sua rotina sem perder estilo.</p>
                    <p class="preco">R$ 500,90</p>
                    <p class="estoque">Estoque: <span class="estoque-valor" data-sku="MGSF-15W">--</span></p>
                    <div class="produto-selecao">
                        <label>
                            <input type="checkbox" name="prod2" value="sim">
                            Adicionar ao Carrinho
                        </label>
                        <select name="qtd2">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>

                <!-- Produto 3 -->
                <div class="produto-card">
                    <img src="img/iphone.png" alt="Produto 3">
                    <h3>IPhone 15</h3>
                    <p>Descubra o iPhone 15, o smartphone que combina desempenho incomparável, câmera avançada e design moderno e elegante. Com processador superpotente, ele garante velocidade e fluidez em todas as tarefas, desde apps do dia a dia até jogos mais exigentes. A câmera de última geração permite fotos e vídeos com qualidade profissional, mesmo em baixa luminosidade. Seu display imersivo oferece cores vibrantes e detalhes incríveis, enquanto a bateria de longa duração acompanha você o dia inteiro. Um iPhone que une tecnologia de ponta e estilo, perfeito para quem busca o melhor em smartphone.</p>
                    <p class="preco">R$ 5.000,90</p>
                    <p class="estoque">Estoque: <span class="estoque-valor" data-sku="IPHN-15-PNK">--</span></p>
                    <div class="produto-selecao">
                        <label>
                            <input type="checkbox" name="prod3" value="sim">
                            Adicionar ao Carrinho
                        </label>
                        <select name="qtd3">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>

                <!-- Produto 4 -->
                <div class="produto-card">
                    <img src="img/aplewatch.png" alt="Produto 4">
                    <h3>Apple Watch</h3>
                    <p>O Apple Watch é o companheiro ideal para o seu dia a dia, combinando tecnologia avançada, monitoramento de saúde e design sofisticado. Acompanhe atividade física, batimentos cardíacos, sono e notificações do seu iPhone diretamente no pulso. Com resistência à água, display nítido e personalizável, ele se adapta ao seu estilo e rotina. Seja para treinos, trabalho ou lazer, o Apple Watch oferece praticidade, performance e elegância em um único acessório.</p>
                    <p class="preco">R$ 2.500,90</p>
                    <p class="estoque">Estoque: <span class="estoque-valor" data-sku="APWT-S9">--</span></p>
                    <div class="produto-selecao">
                        <label>
                            <input type="checkbox" name="prod4" value="sim">
                            Adicionar ao Carrinho
                        </label>
                        <select name="qtd4">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>

                <!-- Produto 5 -->
                <div class="produto-card">
                    <img src="img/airpods.png" alt="Produto 5">
                    <h3>AirPods</h3>
                    <p>Experimente a qualidade de áudio excepcional com os AirPods. Com conexão automática, microfones inteligentes e cancelamento de ruído (nos modelos compatíveis), eles oferecem som cristalino para músicas, chamadas e vídeos. Leves e compactos, proporcionam conforto durante todo o dia e mobilidade total, sem fios atrapalhando. Acompanham você em viagens, treinos e rotina diária, unindo praticidade, tecnologia e estilo em um único acessório.</p>
                    <p class="preco">R$ 999,90</p>
                    <p class="estoque">Estoque: <span class="estoque-valor" data-sku="AIRP-3RD">--</span></p>
                    <div class="produto-selecao">
                        <label>
                            <input type="checkbox" name="prod5" value="sim">
                            Adicionar ao Carrinho
                        </label>
                        <select name="qtd5">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Campos ocultos com informações dos produtos -->
            <input type="hidden" name="nome1" value="Capinha para IPhone">
            <input type="hidden" name="preco1" value="99.90">
            <input type="hidden" name="nome2" value="Carregador MagSafe">
            <input type="hidden" name="preco2" value="500.90">
            <input type="hidden" name="nome3" value="IPhone 15">
            <input type="hidden" name="preco3" value="5000.90">
            <input type="hidden" name="nome4" value="Apple Watch">
            <input type="hidden" name="preco4" value="2500.90">
            <input type="hidden" name="nome5" value="AirPods">
            <input type="hidden" name="preco5" value="999.90">

            <div class="carrinho-preview">
                <h3>Resumo do Carrinho</h3>
                <p>Itens selecionados: <span id="total-itens">0</span></p>
                <p>Valor Total: R$ <span id="total-valor">0,00</span></p>
                <button type="submit" class="btn-ir-carrinho" disabled>Ir para o Carrinho</button>
            </div>
        </form>
    </main>

    <script>
        const API_BASE = 'http://localhost:3001';

        // Limita o select conforme o estoque e desabilita quando stock=0
        function aplicarEstoqueEmCard(card, stock) {
            const checkbox = card.querySelector('input[type="checkbox"]');
            const select = card.querySelector('select');
            const estoqueSpan = card.querySelector('.estoque-valor');
            if (estoqueSpan) estoqueSpan.textContent = typeof stock === 'number' ? stock : '--';
            if (typeof stock === 'number') card.dataset.stock = String(stock);

            // Define o máximo do select: até 5 e também limitado ao estoque
            const maxPermitido = Math.max(0, Math.min(5, Number(stock || 0)));
            // Ajusta opções do select
            Array.from(select.options).forEach(opt => {
                const val = Number(opt.value);
                opt.disabled = val > maxPermitido;
            });

            // Se estoque zerado, desmarca e desabilita seleção
            const semEstoque = maxPermitido === 0;
            if (semEstoque) {
                if (checkbox) checkbox.checked = false;
                if (select) select.value = '0';
                if (checkbox) checkbox.disabled = true;
                if (select) select.disabled = true;
            } else {
                if (checkbox) checkbox.disabled = false;
                if (select) select.disabled = false;
                // Garante que valor atual não ultrapasse o limite
                if (Number(select.value) > maxPermitido) select.value = String(maxPermitido);
            }
        }

        async function carregarEstoques() {
            const cards = document.querySelectorAll('.produto-card');
            const spans = document.querySelectorAll('.estoque-valor[data-sku]');
            // Busca individual por SKU (poucos itens)
            const promessas = Array.from(spans).map(async (span) => {
                const sku = span.getAttribute('data-sku');
                try {
                    const resp = await fetch(`${API_BASE}/api/stock?sku=${encodeURIComponent(sku)}`);
                    if (!resp.ok) throw new Error('Falha ao buscar estoque');
                    const data = await resp.json();
                    const card = span.closest('.produto-card');
                    aplicarEstoqueEmCard(card, data.stock);
                } catch (e) {
                    const card = span.closest('.produto-card');
                    aplicarEstoqueEmCard(card, undefined);
                }
            });
            await Promise.all(promessas);
        }

        // Função para formatar preço em Real
        function formatarPreco(valor) {
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Função para salvar carrinho no localStorage
        function salvarCarrinho() {
            const carrinho = {};
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.querySelector(`input[name="prod${i}"]`);
                const select = document.querySelector(`select[name="qtd${i}"]`);
                const nome = document.querySelector(`input[name="nome${i}"]`).value;
                const preco = parseFloat(document.querySelector(`input[name="preco${i}"]`).value);

                if (checkbox.checked && select.value > 0) {
                    carrinho[`prod${i}`] = {
                        selecionado: true,
                        quantidade: parseInt(select.value),
                        nome: nome,
                        preco: preco
                    };
                }
            }
            localStorage.setItem('carrinho', JSON.stringify(carrinho));
        }

        // Função para carregar carrinho do localStorage
        function carregarCarrinho() {
            const carrinho = JSON.parse(localStorage.getItem('carrinho') || '{}');
            
            for (let i = 1; i <= 5; i++) {
                const produto = carrinho[`prod${i}`];
                if (produto && produto.selecionado) {
                    const checkbox = document.querySelector(`input[name="prod${i}"]`);
                    const select = document.querySelector(`select[name="qtd${i}"]`);
                    
                    checkbox.checked = true;
                    select.value = produto.quantidade;
                    
                    // Atualiza o card do produto
                    const card = checkbox.closest('.produto-card');
                    card.classList.add('selecionado');
                }
            }
        }

        // Função para atualizar o resumo do carrinho
        function atualizarResumo() {
            let totalItens = 0;
            let totalValor = 0;

            // Verifica cada produto
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.querySelector(`input[name="prod${i}"]`);
                const select = document.querySelector(`select[name="qtd${i}"]`);
                const preco = parseFloat(document.querySelector(`input[name="preco${i}"]`).value);

                if (checkbox.checked && select.value > 0) {
                    totalItens += parseInt(select.value);
                    totalValor += preco * parseInt(select.value);
                }
            }

            // Atualiza os elementos na página
            document.getElementById('total-itens').textContent = totalItens;
            document.getElementById('total-valor').textContent = formatarPreco(totalValor).replace('R$', '').trim();

            // Habilita/desabilita o botão do carrinho
            const btnCarrinho = document.querySelector('.btn-ir-carrinho');
            btnCarrinho.disabled = totalItens === 0;

            // Salva o carrinho no localStorage
            salvarCarrinho();
        }

        // Adiciona eventos para os checkboxes e selects
        document.querySelectorAll('input[type="checkbox"], select').forEach(element => {
            element.addEventListener('change', function() {
                const prodId = this.name.replace(/[^\d]/g, '');
                const checkbox = document.querySelector(`input[name="prod${prodId}"]`);
                const select = document.querySelector(`select[name="qtd${prodId}"]`);

                // Sincroniza checkbox e select
                if (this.type === 'checkbox') {
                    if (!this.checked) {
                        select.value = '0';
                    } else if (select.value === '0') {
                        select.value = '1';
                    }
                } else { // select
                    checkbox.checked = select.value > 0;
                }

                // Atualiza o card do produto
                const card = this.closest('.produto-card');
                card.classList.toggle('selecionado', checkbox.checked && select.value > 0);

                atualizarResumo();
            });
        });

        // Validação do formulário (inclui validação de estoque)
        document.getElementById('produtos-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            let temProdutos = false;
            for (let i = 1; i <= 5; i++) {
                const checkbox = document.querySelector(`input[name="prod${i}"]`);
                const select = document.querySelector(`select[name="qtd${i}"]`);
                const card = checkbox.closest('.produto-card');
                const estoqueAtual = Number(card?.dataset?.stock ?? NaN);
                
                if (checkbox.checked && select.value > 0) {
                    temProdutos = true;
                    // Se conseguimos ler o estoque, valida a quantidade
                    if (!Number.isNaN(estoqueAtual)) {
                        const qtd = Number(select.value);
                        if (estoqueAtual <= 0) {
                            alert('Este item está sem estoque. Removendo do carrinho.');
                            checkbox.checked = false;
                            select.value = '0';
                            atualizarResumo();
                            return; // bloqueia o submit
                        }
                        if (qtd > estoqueAtual) {
                            alert(`Quantidade solicitada (${qtd}) excede o estoque (${estoqueAtual}). Ajustando quantidade.`);
                            select.value = String(Math.min(5, estoqueAtual));
                            atualizarResumo();
                            return; // bloqueia o submit (usuário confirma novamente)
                        }
                    }
                    break;
                }
            }

            if (!temProdutos) {
                alert('Selecione pelo menos um produto para continuar!');
                return;
            }

            this.submit();
        });

        // Carrega o carrinho salvo e inicializa o resumo
        carregarCarrinho();
        carregarEstoques().then(atualizarResumo).catch(atualizarResumo);
    </script>
</body>
</html>